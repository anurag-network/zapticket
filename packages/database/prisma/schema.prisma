generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  AGENT
  MEMBER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  ESCALATED
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum MessageType {
  NOTE
  REPLY
}

enum ChannelType {
  EMAIL
  CHAT
  FORM
  SLACK
  DISCORD
}

enum AIProvider {
  OPENAI
  ANTHROPIC
  OLLAMA
}

enum ChatbotStatus {
  GREETING
  COLLECTING_INFO
  CREATING_TICKET
  COMPLETED
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teams          Team[]
  members        User[]
  tickets        Ticket[]
  articles       Article[]
  categories     Category[]
  webhooks       Webhook[]
  forms          Form[]
  workflows      Workflow[]
  apiKeys        ApiKey[]
  channels       Channel[]
  tags           Tag[]
  assignmentRules AssignmentRule[]
  agentWorkloads AgentWorkload[]
  chatbotConfig  ChatbotConfig?
  chatConversations ChatConversation[]
  customerProfiles CustomerProfile[]
  visualWorkflows VisualWorkflow[]
  settings       OrganizationSettings?
}

model OrganizationSettings {
  id             String   @id @default(cuid())
  timezone       String   @default("UTC")
  logoUrl        String?
  primaryColor   String   @default("#3b82f6")

  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Team {
  id             String   @id @default(cuid())
  name           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  members        User[]
  assignmentRules AssignmentRule[]
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String?
  avatarUrl     String?
  role          Role     @default(MEMBER)
  emailVerified DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  teamId         String?
  team           Team? @relation(fields: [teamId], references: [id])
  
  assignedTickets Ticket[] @relation("AssignedTickets")
  createdTickets  Ticket[] @relation("CreatedTickets")
  messages        Message[]
  articles        Article[]
  escalatedTickets EscalationLog[] @relation("EscalatedBy")
  resolvedEscalations EscalationLog[] @relation("ResolvedBy")
  ticketLocks     TicketLock[]
  workload        AgentWorkload?
  ticketCollaborations TicketCollaborator[]
}

model Ticket {
  id            String        @id @default(cuid())
  subject       String
  description   String        @db.Text
  status        TicketStatus  @default(OPEN)
  priority      Priority      @default(NORMAL)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  resolvedAt    DateTime?
  closedAt      DateTime?
  escalatedAt   DateTime?
  escalatedReason String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  assigneeId    String?
  assignee      User?         @relation("AssignedTickets", fields: [assigneeId], references: [id])
  creatorId     String
  creator       User          @relation("CreatedTickets", fields: [creatorId], references: [id])

  channelId     String?
  channel       Channel?      @relation(fields: [channelId], references: [id])

  customerProfileId String?
  customerProfile   CustomerProfile? @relation(fields: [customerProfileId], references: [id])

  messages      Message[]
  tags          TicketTag[]
  formSubmissions FormSubmission[]
  escalationLogs EscalationLog[]
  lock          TicketLock?
  chatConversations ChatConversation[]
  sentimentScores SentimentScore[]
  collaborators TicketCollaborator[]
  responseSuggestions ResponseSuggestion[]
  workflowExecutions WorkflowExecution[]
}

model Message {
  id          String      @id @default(cuid())
  content     String      @db.Text
  type        MessageType @default(REPLY)
  createdAt   DateTime    @default(now())

  ticketId    String
  ticket      Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId    String
  author      User        @relation(fields: [authorId], references: [id])

  attachments Attachment[]
  sentiment   SentimentScore?
}

model Attachment {
  id          String   @id @default(cuid())
  filename    String
  mimeType    String
  size        Int
  url         String
  key         String

  messageId   String
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model Channel {
  id          String      @id @default(cuid())
  type        ChannelType
  name        String
  config      Json?
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  tickets     Ticket[]
}

model Tag {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#6b7280")

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  tickets     TicketTag[]
  articles    ArticleTag[]
}

model TicketTag {
  ticketId String
  tagId    String

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([ticketId, tagId])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  icon        String?
  order       Int      @default(0)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  articles    Article[]
  parentCategoryId String?
  parentCategory   Category?  @relation("CategoryTree", fields: [parentCategoryId], references: [id])
  subCategories    Category[] @relation("CategoryTree")
}

model Article {
  id          String   @id @default(cuid())
  title       String
  slug        String
  content     String   @db.Text
  excerpt     String?
  published   Boolean  @default(false)
  order       Int      @default(0)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  authorId    String
  author      User      @relation(fields: [authorId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])

  tags        ArticleTag[]
}

model ArticleTag {
  articleId String
  tagId     String

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
}

model Webhook {
  id          String   @id @default(cuid())
  url         String
  events      String[]
  secret      String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  deliveries WebhookDelivery[]
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  event        String
  payload      Json
  statusCode   Int?
  response     String?  @db.Text
  deliveredAt  DateTime?
  attempts     Int      @default(0)
  createdAt    DateTime @default(now())

  webhookId    String
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?
}

model Form {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  fields      Json
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  submissions FormSubmission[]
}

model FormSubmission {
  id        String   @id @default(cuid())
  data      Json
  createdAt DateTime @default(now())

  formId String
  form   Form   @relation(fields: [formId], references: [id], onDelete: Cascade)

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id])
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     Json
  actions     Json
  active      Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model ApiKey {
  id          String   @id @default(cuid())
  name        String
  key         String   @unique
  permissions String[]
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model EscalationLog {
  id            String   @id @default(cuid())
  reason        String
  autoEscalated Boolean  @default(false)
  createdAt     DateTime @default(now())

  ticketId      String
  ticket        Ticket  @relation(fields: [ticketId], references: [id])

  escalatedById String?
  escalatedBy   User?   @relation("EscalatedBy", fields: [escalatedById], references: [id])

  resolvedAt    DateTime?
  resolvedById  String?
  resolvedBy    User?   @relation("ResolvedBy", fields: [resolvedById], references: [id])
}

model TicketLock {
  id        String   @id @default(cuid())
  lockedAt  DateTime @default(now())
  expiresAt DateTime

  ticketId  String   @unique
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  lockedById String
  lockedBy   User     @relation(fields: [lockedById], references: [id])

  @@index([expiresAt])
}

enum AssignmentStrategy {
  ROUND_ROBIN
  LEAST_BUSY
  RANDOM
  SKILLS_BASED
}

model AssignmentRule {
  id           String            @id @default(cuid())
  name         String
  description  String?
  strategy     AssignmentStrategy @default(ROUND_ROBIN)
  conditions   Json?
  active       Boolean           @default(true)
  priority     Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  teamId      String?
  team        Team?   @relation(fields: [teamId], references: [id])

  @@index([organizationId, active])
}

model AgentWorkload {
  id              String   @id @default(cuid())
  openTickets     Int      @default(0)
  lastAssignedAt  DateTime?

  agentId         String   @unique
  agent           User     @relation(fields: [agentId], references: [id])

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, openTickets])
}

model ChatbotConfig {
  id              String     @id @default(cuid())
  name            String     @default("Zapdeck")
  welcomeMessage  String     @default("Hi! I'm Zapdeck, your support assistant. How can I help you today?")
  aiProvider      AIProvider @default(OPENAI)
  apiKey          String?
  apiEndpoint     String?
  model           String     @default("gpt-4")
  temperature     Float      @default(0.7)
  maxTokens       Int        @default(500)
  active          Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  organizationId  String     @unique
  organization    Organization @relation(fields: [organizationId], references: [id])

  conversations   ChatConversation[]
}

model ChatConversation {
  id              String        @id @default(cuid())
  sessionId       String        @unique
  status          ChatbotStatus @default(GREETING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  visitorName     String?
  visitorEmail    String?
  category        String?
  description     String?
  
  ticketId        String?
  ticket          Ticket?       @relation(fields: [ticketId], references: [id])

  chatbotConfigId String?
  chatbotConfig   ChatbotConfig? @relation(fields: [chatbotConfigId], references: [id])

  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  messages        ChatMessage[]

  @@index([sessionId])
  @@index([organizationId, createdAt])
}

model ChatMessage {
  id             String   @id @default(cuid())
  content        String   @db.Text
  isBot          Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

enum SentimentType {
  VERY_NEGATIVE
  NEGATIVE
  NEUTRAL
  POSITIVE
  VERY_POSITIVE
}

model SentimentScore {
  id          String       @id @default(cuid())
  score       Float
  type        SentimentType
  confidence  Float
  keywords    String[]
  analyzedAt  DateTime     @default(now())

  ticketId    String?
  ticket      Ticket?      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  messageId   String?
  message     Message?     @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([ticketId, analyzedAt])
  @@index([type])
}

model CustomerProfile {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  phone           String?
  company         String?
  notes           String?  @db.Text
  healthScore     Float    @default(50)
  healthStatus    String   @default("neutral")
  totalTickets    Int      @default(0)
  openTickets     Int      @default(0)
  avgSatisfaction Float?
  lastContactAt   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  tickets         Ticket[]
  healthHistory   CustomerHealthHistory[]
  interactions    CustomerInteraction[]

  @@index([organizationId, healthScore])
  @@index([email])
}

model CustomerHealthHistory {
  id              String   @id @default(cuid())
  score           Float
  status          String
  reason          String?
  recordedAt      DateTime @default(now())

  customerProfileId String
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)

  @@index([customerProfileId, recordedAt])
}

model CustomerInteraction {
  id              String   @id @default(cuid())
  type            String
  summary         String?  @db.Text
  sentiment       Float?
  occurredAt      DateTime @default(now())

  customerProfileId String
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)

  ticketId        String?
  ticket          Ticket?  @relation(fields: [ticketId], references: [id])

  @@index([customerProfileId, occurredAt])
}

model TicketCollaborator {
  id          String   @id @default(cuid())
  joinedAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  isEditing   Boolean  @default(false)
  cursorPosition Json?

  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@unique([ticketId, userId])
  @@index([ticketId])
}

model ResponseSuggestion {
  id          String   @id @default(cuid())
  content     String   @db.Text
  source      String
  confidence  Float
  used        Boolean  @default(false)
  createdAt   DateTime @default(now())

  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model VisualWorkflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  nodes       Json
  edges       Json
  active      Boolean  @default(true)
  triggerType String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  executions   WorkflowExecution[]

  @@index([organizationId, active])
}

model WorkflowExecution {
  id           String   @id @default(cuid())
  status       String   @default("pending")
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  error        String?  @db.Text
  executionLog Json?

  workflowId   String
  workflow     VisualWorkflow @relation(fields: [workflowId], references: [id])

  ticketId     String?
  ticket       Ticket?  @relation(fields: [ticketId], references: [id])

  @@index([workflowId, startedAt])
  @@index([ticketId])
}
